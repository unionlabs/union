pragma solidity ^0.8.27;

import "forge-std/Test.sol";

import "../../contracts/lib/CometblsZKVerifier.sol";
import {
    CometblsClient,
    SignedHeader
} from "../../contracts/clients/CometblsClient.sol";

contract VerifierProxy {
    CometblsClient client;

    constructor() {
        client = new CometblsClient(address(this));
    }

    function verifyZKP(
        bytes calldata zkp,
        bytes31 chainId,
        bytes32 trustedValidatorsHash,
        SignedHeader calldata header
    ) public returns (bool) {
        return client.verifyZKP(zkp, chainId, trustedValidatorsHash, header);
    }
}

contract VerifierTests is Test {
    VerifierProxy proxy;

    function setUp() public {
        proxy = new VerifierProxy();
    }

    // {"version":{"block":11},"chain_id":"union-devnet-1337","height":3405691582,"time":"2024-11-21T17:07:31.998131342+01:00","last_block_id":{"hash":"009B31782C017EDEED99404DBC37EFC7B7B3689C8EF777E53E7A27DBE2C41DD6","parts":{"total":1,"hash":"F0146290F522303FF76B81FF839E2E2A09CA16F233AB6B5496A6DF5F9819BA45"}},"last_commit_hash":"6917693413C4013690A0D2A033EB27066F34D391239F601E0F47FEEC7B055595","data_hash":"256A8F28318D65FE2193C68D834329310186F05D2289FFE03D3AB22F6A84D170","validators_hash":"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4","next_validators_hash":"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4","consensus_hash":"7D07D08BD42C08956B2DB813CCC357FC919ABD89401878C9A5AA4F132E1829EE","app_hash":"EE7E3E58F98AC95D63CE93B270981DF3EE54CA367F8D521ED1F444717595CD36","last_results_hash":"4D266CFC3FA42C3F3DB4C5B105F54CEBCBBC3A5BFDB6AC25BA9CB032EC9A7BDB","evidence_hash":"40D6137CE7FDA8009295029D1D43EEC56F35F01597C0B257A087BB32074DB626","proposer_address":"853EFB9CB0F1E4D82E0D61683C4569C8D52CBF785A571E9DEA232D3E449FCF21"}

    function test_verifyZKP_ok() public {
        assertTrue(
            proxy.verifyZKP(
                hex"03CF56142A1E03D2445A82100FEAF70C1CD95A731ED85792AFFF5792EC0BDD2108991BB56F9043A269F88903DE616A9AB99A3C5AB778E566744B060456C5616C06BCE7F1930421768C2CBD79F88D08EC3A52D7C9A867064E973064385E9C945E02951190DD7CE1662546733DD540188C96E608CA750FEF36B39E2577833634C70AE6F1A6D00DC6C21446AAF285EF35D944E8782B131300574F9A889C7E708A2325E9A78013BBE869D38B19C602DAF69644C77D177E99ED76398BCEE13C61FDBF2E178A5BA028A36033E54D1D9A0071E82E04079A5305347EBAC6D66F6EBFA48B1DA1BF9DC5A51EFA292E1DC7B85D26F18422EB386C48CA75434039764448BB96268DDC2CF683DDCA4BD83DF21C5631CF784375EEBE77EABC2DE77886BF1D48392C9C52E063B4A7131EAB9ABBA12A9F26888BC37366D41AC7D4BAC0BF6755ACB009BF9F36F380B6D0EEAABF066503A1B6E01DCC965D968D7694E01B1755E6BDD21C7A80B41682748F9B7151714BE34AA79AAD48BBB2A84525F6CDF812658C6E4F",
                bytes31(uint248(uint136(bytes17("union-devnet-1337")))),
                0x20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4,
                SignedHeader({
                    height: 3405691582,
                    secs: 1732205251,
                    nanos: 998131342,
                    validatorsHash: hex"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4",
                    nextValidatorsHash: hex"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4",
                    appHash: hex"EE7E3E58F98AC95D63CE93B270981DF3EE54CA367F8D521ED1F444717595CD36"
                })
            )
        );
    }

    function test_verifyZKP_tamperedBlock() public {
        assertFalse(
            proxy.verifyZKP(
                hex"03CF56142A1E03D2445A82100FEAF70C1CD95A731ED85792AFFF5792EC0BDD2108991BB56F9043A269F88903DE616A9AB99A3C5AB778E566744B060456C5616C06BCE7F1930421768C2CBD79F88D08EC3A52D7C9A867064E973064385E9C945E02951190DD7CE1662546733DD540188C96E608CA750FEF36B39E2577833634C70AE6F1A6D00DC6C21446AAF285EF35D944E8782B131300574F9A889C7E708A2325E9A78013BBE869D38B19C602DAF69644C77D177E99ED76398BCEE13C61FDBF2E178A5BA028A36033E54D1D9A0071E82E04079A5305347EBAC6D66F6EBFA48B1DA1BF9DC5A51EFA292E1DC7B85D26F18422EB386C48CA75434039764448BB96268DDC2CF683DDCA4BD83DF21C5631CF784375EEBE77EABC2DE77886BF1D48392C9C52E063B4A7131EAB9ABBA12A9F26888BC37366D41AC7D4BAC0BF6755ACB009BF9F36F380B6D0EEAABF066503A1B6E01DCC965D968D7694E01B1755E6BDD21C7A80B41682748F9B7151714BE34AA79AAD48BBB2A84525F6CDF812658C6E4F",
                bytes31(uint248(uint136(bytes17("union-devnet-1337")))),
                0x20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4,
                SignedHeader({
                    height: 3405691581,
                    secs: 1732205251,
                    nanos: 998131342,
                    validatorsHash: hex"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4",
                    nextValidatorsHash: hex"20DDFE7A0F75C65D876316091ECCD494A54A2BB324C872015F73E528D53CB9C4",
                    appHash: hex"EE7E3E58F98AC95D63CE93B270981DF3EE54CA367F8D521ED1F444717595CD36"
                })
            )
        );
    }
}
