use std::collections::HashMap;

use hex_literal::hex;
use parlia_light_client_types::Header;
use parlia_types::{ValidatorsBitSet, VoteData};
use unionlabs_encoding::{Bincode, DecodeAs};
use unionlabs_primitives::H256;

use super::*;

#[derive(Clone)]
struct BlstContext {
    current_timestamp: Timestamp,
    epoch_valsets: HashMap<u64, Valset>,
}

// will never be BLST_SUCCESS
#[derive(Debug, Clone, thiserror::Error)]
#[error("{0:?}")]
pub struct BlstError(blst::BLST_ERROR);

impl BlstError {
    fn new_result(e: blst::BLST_ERROR) -> Result<(), Self> {
        if e == blst::BLST_ERROR::BLST_SUCCESS {
            Ok(())
        } else {
            Err(Self(e))
        }
    }

    fn new(e: blst::BLST_ERROR) -> Self {
        Self::new_result(e).unwrap_err()
    }
}

impl VerificationContext for BlstContext {
    type Error = BlstError;

    fn current_timestamp(&self) -> Timestamp {
        self.current_timestamp
    }

    fn get_valset(&self, epoch_block_number: u64) -> Result<Valset, Self::Error> {
        Ok(self.epoch_valsets.get(&epoch_block_number).unwrap().clone())
    }

    fn verify<'pk>(
        &self,
        public_keys: impl IntoIterator<Item = &'pk H384>,
        msg: &[u8],
        signature: H768,
    ) -> Result<(), Self::Error> {
        let agg_sig =
            blst::min_pk::Signature::uncompress(signature.get()).map_err(BlstError::new)?;

        BlstError::new_result(
            agg_sig.fast_aggregate_verify(
                true,
                msg,
                b"BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_POP_",
                &public_keys
                    .into_iter()
                    .map(|pkey| {
                        blst::min_pk::PublicKey::uncompress(pkey.get()).map_err(BlstError::new)
                    })
                    .collect::<Result<Vec<_>, _>>()?
                    .iter()
                    .collect::<Vec<_>>(),
            ),
        )
    }
}

#[track_caller]
fn deser_header(json: &str) -> ParliaHeader {
    serde_json::from_str(json).unwrap()
}

macro_rules! valset {
    ($([$addr:literal, $pubkey:literal$(,)?]),*$(,)?) => [
        Valset::new([$((
            hex!($addr).into(),
            hex!($pubkey).into()
        )),*])
    ];
}

#[test]
fn calculate_signing_valset_epoch_block_number_works() {
    let cases: &[(u64, u64)] = &[
        // 8 * (7 / 2) -> 8 * 4
        (50932032, 50931000),
        // (8 * (7 / 2)) + 1 -> (8 * 4) + 1
        (50932033, 50932000),
    ];

    for &(h, expected) in cases {
        assert_eq!(calculate_signing_valset_epoch_block_number(h, 7), expected);
    }
}

#[test]
fn header_hash() {
    let header = deser_header(
        r#"{"withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","parentHash":"0x456e27b4d951b8503078f5fa44d20f8d2ce976f4424a9c45782b73658c856d50","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","miner":"0x8a239732871adc8829ea2f47e94087c5fbad47b6","stateRoot":"0x2f3a8a8a47bc02231865163b9cc539e67a10e97bf8acc30279f2649f7c21cc85","transactionsRoot":"0x99f7054aa082decd3ac39e0a8d9189ec4d1d91fe953b2ada2cce29ec3a5715e6","receiptsRoot":"0x903944bf3a03f3933949bf9355dc73be8be02dfbf86d4066a1b6e41f0251346f","logsBloom":"0x05b1561781c6205dcea13c5b96cb1a801fd0b40a1e1b6ba42f80e21636949a9db102798b165f02212689f5202c8a83818904b22014dc6085068aa319552805d1fc0adf0c13684c3c43946d4cb63b9e24b490cabb336ac12e201500d0da2b9e68c3db07217846b842edec4337d71679a70d82841746856c0047acc8dda2a9a3db9084cd223a5c7a4889883b96bd4087f3e87eec65b19be169028280e18306572062ec04c9032e97a1ab0e3371c6644771d3aa36c0408e090d09dfb1a9e1ab9899b869e1ae4dc080a1aab47198c11acb09f1889d333ba42e983072dc73b404c8010ad30b178da4481309f5a28d926781c11491f7a0684b357b71ee177fb2c16721","difficulty":"0x2","number":"0x30a4c62","gasLimit":"0x7735940","gasUsed":"0x18fe8b7","timestamp":"0x68437ede","extraData":"0xd88301050c846765746888676f312e32332e37856c696e75780000003bfc8c16f8b5831f7fffb860906c1bdcc84b3cfbbab0f3df2939413a36c373e351fe7ec6654cf983b8d6ae80f052d2a66bddcf7bf6f4c28754c4dc770e68597fba67ee38748639c31083ed517ccaae5836e421d4b0ba0234173b456646d8146f0063846eb660e1fdcf91f3baf84c84030a4c60a0db7cefa3c1fe375262865b93e4d4223b045da94df8fd769875fb5fc7f73056da84030a4c61a0456e27b4d951b8503078f5fa44d20f8d2ce976f4424a9c45782b73658c856d508003ce6d018ef27172e9d39c346aa0dc3a939a4cc3766078b54311526b987d418332d87369564cf5421fd122417e61369bff2c85e967e2ce875936ef1cd57b321d01","mixHash":"0x00000000000000000000000000000000000000000000000000000000000001f4","nonce":"0x0000000000000000","baseFeePerGas":"0x0","blobGasUsed":"0x40000","excessBlobGas":"0x0","parentBeaconBlockRoot":"0x0000000000000000000000000000000000000000000000000000000000000000","requestsHash":"0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"}"#,
    );

    assert_eq!(
        header.hash(),
        <H256>::new(hex!(
            "20315dee443b8910db5041505a17758cc44ac2348af003a08760f9a14995f3ae"
        ))
    );
}

#[test]
#[ignore = "need to find epoch rotation block with no vote attestation"]
fn parse_epoch_rotation_header_extra_data_no_vote_attestation() {
    todo!()
}

#[test]
fn parse_extra_data() {
    let ed = hex!(
        "db8301060588663832386233306189676f312e32342e3131836c696e4d518ce1151cfdbd2dff70c6e2e30df5012726f87731f381648e9879d77f0f25c8f6348135cef7477c2455f516bec180921d4c669eae7258857327674ace724b598c0df3fd41068ef8286c1b674d48cff67b4096b6c1dc22e769581e91a2783aa7911798eb2b7e5a3c61832f65731e14789cf1d624de2c83535d7719b466cdb2057beff302eab6c3cbfb42ee2337e9627a91dd13e453246856d58797ad6583d762abd04e3688a7c071dbc7eb3d0ace1c06baf163fdc8ffc742fec16f09fa468d30778a3c533b944899d33ae3225a3aee07460a252b4feefa821d3351731220627d7b7d1f3db3e34a6e7967c4da80dd3e5227acb02c92f33a026bbce5e52c19b7d8746b7e55d3e29b9083de0bf334fdf8ac91bc14854e5acf9684652bea56f2f01b7101a225ee33d23f8bcfeba8fcafdc6b6f9016d5a0dd08e4685a13bffd8c2087f66bf7ca2dace7fbbc40c40824e30a84d3fe62a2ddcd52175009317fd4f6f8feea9dae41e5f0a4737bb7a7d5b3a0de43e5a979f8d7a9ad04f8f3f102bdbb17ef0bf6ac9a8fce3f110f409d99828be80295da56c2c7a7becd3647ce40502aecfe253e6aa0e8d2a06e12438ffed0fe16a0b15df58914a6b751909f0558a9f9af8efca7d46e480fc24478d977dafe7daf5161b38c72e9e1ea4865c288ef5b8054ab58567f7a51a58708c8b40ec592a38ba64c0697de8d78def84b10ab93dbfff6980d1054a2bc561bcf0abf3daf6096849bf03744fd4a49392e4813dc2251d68f6f95f27ba75cf810ab8c718ac065b45f892a5badab2b2946b9b9d313d561cc9d7a90342230d649d6b001f339e21e4fb996e643fddb38a9cbb58e48cad1510d1d72dfb2949c0e97b88275b851a27d7101438f45fce31816501193239a83ad9a5f4ae5ec7dd886b09a47021461ec6f1971b3558f31e622311e94714398c80573fd531e0e8b4c4c3b456c4a5b9bf67b501c7944185130dd4ad73293e8aa84effdcee7b7adb10448b8be5fc875af7df065a5ee57f2ace2cca77b37bbe2e30fd16481afe8a64fe4dd3aff03d14fb180a05bf6a07e1fdf03eb3ac35bf0256694d7fbe6b6d7b3e0c8a066981de27634c2d17a68333f6d9b0c8cd7e08882c397c6ad92d95f8c279d6ef9ea04a1e2f4c4cdfe7ea6015f367ccb8a239732871adc8829ea2f47e94087c5fbad47b6adc9ae11a5f0da15082a4ded8abaeb73338984c06e2c1af2eb24232e00511e95b24e89291d689f6bedb13d5a398af2ec9bb56c2b4dbe5a06d79911c9899b6f817696acfc90ba8c56b1a3c032a3a0395d0f42f3a00b4f50ce9dc41f819a601e8f17b00e7a4eba8a9af4c4b3fdd31d555ccf70058d9f1b7fae54be07f4fee34eb1aacb39a1f7b6fc92abfb714bc2daced46244ccab91917be3d8271a995636b24aa44ff97e3033f41262b2dad5ce2b31734e4dd3912c5838eeb4647b856cb9c3856d559c885bed8b43e0846a47a663982486c84b2f66d9391efe6875d30be1d907e55d9c4a5a224de92a5d8ff180cc4ebca44253fa5a9730cc89d61994bdcc079bbb23c1d9a6f36aa31309676c258abac7a2564fd6f7101c1fdb441018a24d25672826953caa03b6717e26e8af1c38507dd570bdedf1cb270c376630823f101577ca503a7ed99eca485da2e875aedf7758472c378c91dce99bbdc44ee9500ed1e5c864bc88ba518585c7e6de5e94d26ee216dd8a5e06c5d2fc740123976c9588787b54998cd3b0d838ccceae7ebf1781d11d1bb741db7fe1a7b39bdc22b7275d8456ee325424d33829d364270b1ecebb389318c7f0cb1f1c334f05d1d5e26472f2cd07f5d8025ea266d849d1df66bff1c2739b4399425755c2e0fabbaba0bbbfbf2714045f3740e000f297f3e810118f9082cc306c235a23bc1752b8c812fe5ad273219b09675ae356cf2d2d27f8de5e61322302b2c6e0a525cc842f10332811bf8e69853df9edb142b5d596f93bfa14253a733cb9d2d5a7ed1fc345e248a8cae7f23f438930123eebf61c98785d846a8b08f8b5830f7fffb8609741a8dafebeba3d96e2f0860fad4fbae80732194afc97baf10c277bf32b7d24304c965366d70b243d2d91d6798a2a1b11528c9aec549ebf1bf92d51d8bddfa5b19724ca3b176747a681f48d7b62975093904fb7b2509a6cc1ff03477eadf199f84c84048d5436a0bce486a5cb1e2cf4da1af97a1fbc7146fe02305de408b42a5e8c9e4fa3aebb8a84048d5437a0a967b1f6c1215939989c7fab0474fb931271e5bd95eed526922f13591f845fd5806042f7c15ccad026748769a022b4feee0f5a4ce1121c9c68d147035cce5eb7c42ca8bb461362d29b958be77246d17c12f4ef055740caabe880d91360aa4dc92701"
    );

    let ed = parse_epoch_rotation_header_extra_data(&ed).unwrap();

    let expected = (
        Some(VoteAttestation {
            vote_address_set: ValidatorsBitSet::new(
                0b00000000000000000000000000000000000000000011110111111111111111,
            ),
            agg_signature: hex!("9741a8dafebeba3d96e2f0860fad4fbae80732194afc97baf10c277bf32b7d24304c965366d70b243d2d91d6798a2a1b11528c9aec549ebf1bf92d51d8bddfa5b19724ca3b176747a681f48d7b62975093904fb7b2509a6cc1ff03477eadf199").into(),
            data: VoteData {
                source_number: 76370998,
                source_hash: hex!(
                    "bce486a5cb1e2cf4da1af97a1fbc7146fe02305de408b42a5e8c9e4fa3aebb8a"
                )
                .into(),
                target_number: 76370999,
                target_hash: hex!(
                    "a967b1f6c1215939989c7fab0474fb931271e5bd95eed526922f13591f845fd5"
                )
                .into(),
            },
            extra: b"".into(),
        }),
        valset![
            [
                "1cfdbd2dff70c6e2e30df5012726f87731f38164",
                "8e9879d77f0f25c8f6348135cef7477c2455f516bec180921d4c669eae7258857327674ace724b598c0df3fd41068ef8",
            ],
            [
                "286c1b674d48cff67b4096b6c1dc22e769581e91",
                "a2783aa7911798eb2b7e5a3c61832f65731e14789cf1d624de2c83535d7719b466cdb2057beff302eab6c3cbfb42ee23",
            ],
            [
                "37e9627a91dd13e453246856d58797ad6583d762",
                "abd04e3688a7c071dbc7eb3d0ace1c06baf163fdc8ffc742fec16f09fa468d30778a3c533b944899d33ae3225a3aee07",
            ],
            [
                "460a252b4feefa821d3351731220627d7b7d1f3d",
                "b3e34a6e7967c4da80dd3e5227acb02c92f33a026bbce5e52c19b7d8746b7e55d3e29b9083de0bf334fdf8ac91bc1485",
            ],
            [
                "4e5acf9684652bea56f2f01b7101a225ee33d23f",
                "8bcfeba8fcafdc6b6f9016d5a0dd08e4685a13bffd8c2087f66bf7ca2dace7fbbc40c40824e30a84d3fe62a2ddcd5217",
            ],
            [
                "5009317fd4f6f8feea9dae41e5f0a4737bb7a7d5",
                "b3a0de43e5a979f8d7a9ad04f8f3f102bdbb17ef0bf6ac9a8fce3f110f409d99828be80295da56c2c7a7becd3647ce40",
            ],
            [
                "502aecfe253e6aa0e8d2a06e12438ffed0fe16a0",
                "b15df58914a6b751909f0558a9f9af8efca7d46e480fc24478d977dafe7daf5161b38c72e9e1ea4865c288ef5b8054ab",
            ],
            [
                "58567f7a51a58708c8b40ec592a38ba64c0697de",
                "8d78def84b10ab93dbfff6980d1054a2bc561bcf0abf3daf6096849bf03744fd4a49392e4813dc2251d68f6f95f27ba7",
            ],
            [
                "5cf810ab8c718ac065b45f892a5badab2b2946b9",
                "b9d313d561cc9d7a90342230d649d6b001f339e21e4fb996e643fddb38a9cbb58e48cad1510d1d72dfb2949c0e97b882",
            ],
            [
                "75b851a27d7101438f45fce31816501193239a83",
                "ad9a5f4ae5ec7dd886b09a47021461ec6f1971b3558f31e622311e94714398c80573fd531e0e8b4c4c3b456c4a5b9bf6",
            ],
            [
                "7b501c7944185130dd4ad73293e8aa84effdcee7",
                "b7adb10448b8be5fc875af7df065a5ee57f2ace2cca77b37bbe2e30fd16481afe8a64fe4dd3aff03d14fb180a05bf6a0",
            ],
            [
                "7e1fdf03eb3ac35bf0256694d7fbe6b6d7b3e0c8",
                "a066981de27634c2d17a68333f6d9b0c8cd7e08882c397c6ad92d95f8c279d6ef9ea04a1e2f4c4cdfe7ea6015f367ccb",
            ],
            [
                "8a239732871adc8829ea2f47e94087c5fbad47b6",
                "adc9ae11a5f0da15082a4ded8abaeb73338984c06e2c1af2eb24232e00511e95b24e89291d689f6bedb13d5a398af2ec",
            ],
            [
                "9bb56c2b4dbe5a06d79911c9899b6f817696acfc",
                "90ba8c56b1a3c032a3a0395d0f42f3a00b4f50ce9dc41f819a601e8f17b00e7a4eba8a9af4c4b3fdd31d555ccf70058d",
            ],
            [
                "9f1b7fae54be07f4fee34eb1aacb39a1f7b6fc92",
                "abfb714bc2daced46244ccab91917be3d8271a995636b24aa44ff97e3033f41262b2dad5ce2b31734e4dd3912c5838ee",
            ],
            [
                "b4647b856cb9c3856d559c885bed8b43e0846a47",
                "a663982486c84b2f66d9391efe6875d30be1d907e55d9c4a5a224de92a5d8ff180cc4ebca44253fa5a9730cc89d61994",
            ],
            [
                "bdcc079bbb23c1d9a6f36aa31309676c258abac7",
                "a2564fd6f7101c1fdb441018a24d25672826953caa03b6717e26e8af1c38507dd570bdedf1cb270c376630823f101577",
            ],
            [
                "ca503a7ed99eca485da2e875aedf7758472c378c",
                "91dce99bbdc44ee9500ed1e5c864bc88ba518585c7e6de5e94d26ee216dd8a5e06c5d2fc740123976c9588787b54998c",
            ],
            [
                "d3b0d838ccceae7ebf1781d11d1bb741db7fe1a7",
                "b39bdc22b7275d8456ee325424d33829d364270b1ecebb389318c7f0cb1f1c334f05d1d5e26472f2cd07f5d8025ea266",
            ],
            [
                "d849d1df66bff1c2739b4399425755c2e0fabbab",
                "a0bbbfbf2714045f3740e000f297f3e810118f9082cc306c235a23bc1752b8c812fe5ad273219b09675ae356cf2d2d27",
            ],
            [
                "f8de5e61322302b2c6e0a525cc842f10332811bf",
                "8e69853df9edb142b5d596f93bfa14253a733cb9d2d5a7ed1fc345e248a8cae7f23f438930123eebf61c98785d846a8b",
            ],
        ],
    );

    assert_eq!(ed, expected);
}

#[test]
fn testnet_85576000_ancestor_attestation_for_epoch_rotation_block() {
    let header = Header::decode_as::<Bincode>(&hex!(
        "58c519050000000004000000000000001b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e009fba05c7a11ece03605aa39d4547fdf88879dcf24e6ab42002afcef9736166b5adafd0e270c2cbbd98aa3981d277b454de95d78e5a344326e2e85e60341ae95754b58c162523ed2226e69b09e4e946bb4e6518fc0a5758fe9783bf18ef4a0ed040000004000400000000040000000000200000000000000000000000200000000001000000000000000100000000000000000000000000000000000000000000000000000000001000000000000000021100000040000000000000000000000000c0020800200010000000000000000080004000000000000200000000000000000080000000000000000000000020000000400000000020000000000000020000000000000002008000000028000000000000000001000000000000000000000000000000000000000042000000000400000001000024000104802000000000000000000000000011000840000010400088000008000004100200000000000020000000000000000000000000000000000000000000000000000000000000040c9190500000000000000000000000000000000000000000000000000000000775ef70500000000e74c030000000000c1c46f69000000007d0300000000000000000000000000000000000000000000000000000000000000000000000000000908265da01e1a65d62b903c7b34c08cb389bf3d9996f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c21a3d9d7a717d64e6088ac937d5aacdd3e20ca963979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd99850023032415e630b9b3489639dee7de21274ab64016226a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c53387f3321fd69d1e030bb921230dfb188826affaa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b76d76ee8823de52a1a431884c2ca930c5e72bff3803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf798443fb327cad5dfd47ca4ddb15bb876d6c40e091b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f267f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf90409f56966b5da954166eb005cb1a8790430ba1962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5d447b49cd040d20bc21e49ffea6487f5638e4346ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb08f8b48201ffb860913a9ed7fe9bfbe749272684dc2b1d16f1934ffc775ca8f408a6cab74977263e15a61677e0642a323a933bd585e66813108bac33a479f5f1e9d5be8d0f419b4eaa8108bed049ce94c233dca6c122d9419168bb4f5416075af99ad7d1a82a6054f84c840519c93ea09ebd3dd083051861c56bd2ced35d29854ea6339e64b49949f71bfa295ce9c30d840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a80ba25c17d0755008ddbcb85a0a82c813a977c78b3923613c3d3939a39e900e8d05e66017b628a499e1df929db8ebfe3923d1bf3cfe77ea716ac16983c19a9960a0000000000000000000000000000000000000000000000000000000000000002580000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e71dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0a7c3244e3d9864f6dce79aa2814b0d5749dde74929ecccb31f09e55f091f052d388cd48da311e54bad28832f05ba5be7da5b82405b1f707c00f5319b1ac657fa3db0b077374fd66a6f595255d93b3aedd7799d834fbc940b62bda414b7f94bd300000000000000000000004000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000002000000000000000000000000000000002010000004000000000000000000000000080020000200000000000000000001080000000000000000000000000000000000000000000000000000000000000000000400000000400000080000000020000000000000002008000000020000000000000000000000000000000000800000000000000000000000000000000000000000001000000000104002000000000000000000000000010000040000010000088800000000004000000000000000020000000000000000000000000000000000000000000000000000000000000041c91905000000000000000000000000000000000000000000000000000000004ddcf80500000000de46010000000000c2c46f690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b482017fb860abb6798ac8cc9f3434576c3d6e1fe826e9460eded136b70a1685dcbc289657dbee0e14f2059e65faf6d922459ea66ba20489ce7f8d84a431609d428dba46d71744b942d8196a8edf239d5b1630929877a3d9fd8d88779d509a410f31c76a7c3ff84c840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a840519c940a0098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e78068c0679c9640033a6e6c617147185a739260b7ea6c2fe48f73d30aed2bd044cf50965f90de1294fa84cb05218a56d00094e502da6e100be7caab71877ab191e00100000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855a7662681beb5fb69d32cc869dded69b0a4abeb3af22c95e4790e2393b0f8a4ac1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e01a8042b95cade79f8241ba68f8423655e6ca24eba3c05b4e7ef149d5390b145774c0b27fdf5c08b695921527773f159ae2f2d2698f15191da63626b04ad2488947f8daabeb56faf4e9e88485084f5902a6b365f6adf778bb8b6745e45f70ee35048000000000000000000040000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000010000000000000000000000000000000080000100020100000040000000000000000000000000800200002000000000000000000000800000000004000000000140010000000000000400000000000000000000000000404000000000000000000000000200000000000000020080001000200000000000000000000400000000000000000040000024000000080000000000000000000008010000000001440a2000020000000000000000000010000240000010000088000048000004000000000000000020000000000000000000000000000000000000000000000000000000000000042c9190500000000000000000000000000000000000000000000000000000000835afa05000000003029020000000000c2c46f6900000000610000000000000000000000000000000000000000000000000000000000000000000000000000003bf215bb1f1785155eec5a5b53ef9776829a8a4d25a58252db80182f8369c1eb696e62b4ae8365bcb49cf90cee6cbdfa0a7cf82d5c1c187d6de660a75cfda9960000000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b8555311a5791900294964106c70a4262af2b629362c7b113317d4d0f6174e33a2bf1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0120b7861fd08e3816ad4874c3d24b48841102e888e004a61426791328c32cdf2df5706ed485fc084a3e6c8291ecdc66e51f2c8b0c7016d85eb702d81efb4e02e1b1afaa8c00ebae540f9db25dbcd80d44a99471d15320b88cde40b94dd23b700048000000000400000000040000000000000000040000000000010000000000000011010000000000000000000000000040000000000000000000010040400000000024000000000000000080000100020100000040400000000000040000000001800200002000000000000200000000800000000004000000000140000000000000000400000080000000020020000000004000000000000000000000000200000000000000020080001000200000080000000000100400000000000000000000000024000100080000000000000000000008010000000001440a2000060000000000080000000010000240000010000088000048000004000000000080000020000000000000000000000000000000000000000000000000000000000000043c919050000000000000000000000000000000000000000000000000000000018d9fb0500000000b6eb040000000000c2c46f690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b48201ffb860a0e83e3120229fcb1e1f661cbe2c33f281546a22bd4fa6ebcadef6cddffff9e9e8432b3e0f8c26b9b28d34f7019db11a04cd856d82a93bf02e41db2b1f980d20ab8fa1289f393eaf84459808f693e23d7a4e40a35ef228a87cbd43a0a0c9c2a1f84c840519c940a0098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e7840519c942a05311a5791900294964106c70a4262af2b629362c7b113317d4d0f6174e33a2bf80edb8db748918ed6eec4c9c5c5be9122a4e145c77605f8568cca502bcbacee04f5e6d88113897c39dafe1aef90991dcf4697db6e48502cef92760aeaba5c36d010000000000000000000000000000000000000000000000000000000000000003b60000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
    )).unwrap();

    let valset = valset![
        [
            "08265da01e1a65d62b903c7b34c08cb389bf3d99",
            "96f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c2"
        ],
        [
            "1a3d9d7a717d64e6088ac937d5aacdd3e20ca963",
            "979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd998500230"
        ],
        [
            "32415e630b9b3489639dee7de21274ab64016226",
            "a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c"
        ],
        [
            "53387f3321fd69d1e030bb921230dfb188826aff",
            "aa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b"
        ],
        [
            "76d76ee8823de52a1a431884c2ca930c5e72bff3",
            "803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf"
        ],
        [
            "798443fb327cad5dfd47ca4ddb15bb876d6c40e0",
            "91b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f26"
        ],
        [
            "7f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea",
            "99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf"
        ],
        [
            "90409f56966b5da954166eb005cb1a8790430ba1",
            "962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5"
        ],
        [
            "d447b49cd040d20bc21e49ffea6487f5638e4346",
            "ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb"
        ]
    ];

    let ctx = BlstContext {
        current_timestamp: Timestamp::from_nanos(1753916740000000000),
        epoch_valsets: [(85575000, valset)].into_iter().collect(),
    };

    let res = verify_header(&header.chain, Duration::from_secs(604800), 85575000, ctx).unwrap();

    assert_eq!(res.0.number, U256::from(85576000_u64));
    assert_eq!(res.1.unwrap().0, 85576000);
}

#[test]
fn testnet_86268000_epoch_rotation_block() {
    let header = Header::decode_as::<Bincode>(&hex!(
        "605824050000000003000000000000009afad60b2d2bcd473c22b18e4aa80e166c7817b0cca60ba6cea6d3529867d1bb1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0d68db57bbded5830acd8f277867799e9f1c295ce3f70c9846b775d6b4c67bcbe30758b2d3cb4658ea460e0520dd0dd4d94656968321e9fc2bcf1e83a144509f1ad3d261f3028764199b4e9c47422445c1b08ac77a7722cb25b7d69d910fbee28040000004000400000000040000000000200000000000000000000000200000000001000000000000000100000000000000000000000000000000000000000000000000000000001000000000000000021000000040000000000000000000000000400208000000100000000000000000000040000000000002000000000000000000800000000000000000000000200000004000000000200000000000000000000000000000000000000000280000000000000000010000000000000000000000000000000000000000420000000004000000010000240000048000000000000000000000000000010008400000004000880000080000001002000000000000200000000000000000000000000000000000000000000000000000000000000485c240500000000000000000000000000000000000000000000000000000000775ef705000000003d21020000000000f88d7469000000007d0300000000000000000000000000000000000000000000000000000000000000000000000000000908265da01e1a65d62b903c7b34c08cb389bf3d9996f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c21a3d9d7a717d64e6088ac937d5aacdd3e20ca963979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd99850023032415e630b9b3489639dee7de21274ab64016226a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c53387f3321fd69d1e030bb921230dfb188826affaa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b76d76ee8823de52a1a431884c2ca930c5e72bff3803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf798443fb327cad5dfd47ca4ddb15bb876d6c40e091b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f267f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf90409f56966b5da954166eb005cb1a8790430ba1962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5d447b49cd040d20bc21e49ffea6487f5638e4346ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb08f8b482017fb860a5e0d5ccc19ed008b0be1973c54f921cc6eaff6fd2f43f32617ddac153982c98a7d83884bbfa01bab03b53e6ae3fb4e11750d9e649c961842104bfade0a8243b1ab7b065deaaca8b88deed2d443bf25c65e983610302ebe4519192b7fe9767a2f84c8405245c46a0838afe08d60d59cd3f770f099722f5565a57b22d900abdf9126758130443bf768405245c47a09afad60b2d2bcd473c22b18e4aa80e166c7817b0cca60ba6cea6d3529867d1bb807755a3a4798dc87b733546e5c164e320f020588eba7149193488a1a0869eaff11d25d8d76ad990981a1ddf96bf4ca05a39acede64d137f00224239c86ebc35300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b8555d08897fc8aea95d1c16b6b33c512065820d459edf61197f08811dd897028bd61dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e056d2d39e259845a57a5ed3d7080bf6e734d3d1137500a4b8ae5228c6da1651870fb7c41877555b742b4f6f856073789d664dc9a7ab5fbfeaf36625f904eb4b2fbbe76727246bca14c62c38395ec9cf2da7c5e8a741d6674b8fe7c72e71ac4f12000000000000000000000040000000000000000010000000100000000000000000001000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000020100000040002000000000000000000000800200202002000000000000008000800000000000000000000000000008000000000000000000000000000000000000004000002000000000000000000200000008000000020080000000200000000000000000000000010000000000000000000000000000000000000080000000000000010000000001040020000200000000000400000000100000400020100000880000000000040000000000000000200000000000000000000000000000000000000000000000000000000000000495c2405000000000000000000000000000000000000000000000000000000004ddcf805000000001602030000000000f88d74690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b48201ffb86088ebba853fd3b872d5b429ddf9cd384bac667b4423ee1f70b042df0c010c865270922c61b6bc390df9465d173c4b10ed00e7fb6487722041b7e5b865b08fcf6c78c7eddb0fd0850605689789af1961a6dea104492819c532fec5c127e65a7114f84c8405245c47a09afad60b2d2bcd473c22b18e4aa80e166c7817b0cca60ba6cea6d3529867d1bb8405245c48a05d08897fc8aea95d1c16b6b33c512065820d459edf61197f08811dd897028bd680f13e6f8b7c4b6478b2fd9bb55937fe747ee3b221dc25ca08abdde5505ec021fb5c38977f71ca1a010f8264b97ed5a314d5192ddf70de06dcb90886f8010abdc10000000000000000000000000000000000000000000000000000000000000001c20000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b8553e9fe419ae9d30369dfd8be605039575e038d257670b52bbc4774f3c6eea44e01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0ddd124e34f0b7a91b18981a12ed5a133bd7573e8731a6e0b73d6b93ac32195de73d8f3afd2463861893e32dbeec56983b305d65489eea76d651659f5fc072537a88c915324765b77ecbea96350d289637b712b5871e46c202b72655c676579cf0080000080000000000040400000000000000000000000000002000000000000000110000000000000000000000000000000000000000080000000100004000000040000000000020000000800000000241000000404000000000000000000000008002000020020080000000101000008000000000040000000001400000000000000004000000020200000000000000000040000000000000000000400002000080000000000200880000002010000000000000000004000040000000000000000000240000000000000000000000000000080100000000014402200006000000000000000000001000024000001000008800004000100400000840000000002000000000000000000000000000000000000000000000000000000000000004a5c240500000000000000000000000000000000000000000000000000000000835afa05000000000238040000000000f88d74690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b48201ffb8608bce960906860125e2335739620934aec6e9f54690996d4f07842408041ad7e55feb8671e7673ec7a41cdeee32843a1d090de9da868704ab299c307500b7b4e874c35d27609d5a25dab15aa0263252ef82d724c6a7a3ea8b77b57db31f9c34faf84c8405245c48a05d08897fc8aea95d1c16b6b33c512065820d459edf61197f08811dd897028bd68405245c49a03e9fe419ae9d30369dfd8be605039575e038d257670b52bbc4774f3c6eea44e080723a51a9947b540efe81dd67e6d215e344e3e6bd68d6288cd8b6e3ba0192594023146e03872e320e192b86de632d13dde79763324a7911fbaa1fb217e53badd50000000000000000000000000000000000000000000000000000000000000003840000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b9c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
    )).unwrap();

    let valset = valset![
        [
            "08265da01e1a65d62b903c7b34c08cb389bf3d99",
            "96f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c2"
        ],
        [
            "1a3d9d7a717d64e6088ac937d5aacdd3e20ca963",
            "979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd998500230"
        ],
        [
            "32415e630b9b3489639dee7de21274ab64016226",
            "a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c"
        ],
        [
            "53387f3321fd69d1e030bb921230dfb188826aff",
            "aa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b"
        ],
        [
            "76d76ee8823de52a1a431884c2ca930c5e72bff3",
            "803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf"
        ],
        [
            "798443fb327cad5dfd47ca4ddb15bb876d6c40e0",
            "91b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f26"
        ],
        [
            "7f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea",
            "99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf"
        ],
        [
            "90409f56966b5da954166eb005cb1a8790430ba1",
            "962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5"
        ],
        [
            "d447b49cd040d20bc21e49ffea6487f5638e4346",
            "ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb"
        ]
    ];

    let ctx = BlstContext {
        current_timestamp: Timestamp::from_nanos(1753916740000000000),
        epoch_valsets: [(86268000, valset)].into_iter().collect(),
    };

    let res = verify_header(&header.chain, Duration::from_secs(604800), 86268000, ctx).unwrap();

    assert_eq!(res.0.number, U256::from(86269000_u64));
    assert_eq!(res.1.unwrap().0, 86269000);
}

#[test]
fn supermajority_not_reached() {
    let header = Header::decode_as::<Bincode>(&hex!(
        "e8ee23050000000003000000000000007391e48b0d7ac748ec371296321c0e50d06287ea6d32338f7137bc91c0fb74ef1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0733a14f30581f1ec1876776f679a922f21b4ed8dd34b99bea9f68f3a969ca0a1a531856183150eb557e138d47795abaacbe6c6af53af8f7aeac3bad820f3f311452c1690c17ed2cc0d0155c06d019af49f46bc0d0fdd66f47afddcd81aabae15048000004000400020004040004000000200020000000000004010000200000100011000000020000000100040021018000000000480000000000010000400000000000000000101000000080000000023100024140400000000000200000000001c00608002000100000000000008008808040000004000002000940400000000000a004420000000000000000082120000040000000002000000000000002000000000000000200c820100028100000000000000031040008000000000000000004002404080080000042220000000400000801400024000144822000060020000008000000820091300a419020104000880000480000241002000000010000200000000000000000000000000000000000000000000000000000000000000d0f2230500000000000000000000000000000000000000000000000000000000775ef705000000001adf1100000000003d5e7469000000007d0300000000000000000000000000000000000000000000000000000000000000000000000000000908265da01e1a65d62b903c7b34c08cb389bf3d9996f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c21a3d9d7a717d64e6088ac937d5aacdd3e20ca963979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd99850023032415e630b9b3489639dee7de21274ab64016226a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c53387f3321fd69d1e030bb921230dfb188826affaa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b76d76ee8823de52a1a431884c2ca930c5e72bff3803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf798443fb327cad5dfd47ca4ddb15bb876d6c40e091b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f267f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf90409f56966b5da954166eb005cb1a8790430ba1962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5d447b49cd040d20bc21e49ffea6487f5638e4346ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb08f8b48201ffb860a0158ad02f16083b055bd1459552db9126ac10db1d1ab05becf7466f829a3961af4d6a39b598aef722f47cdca541929a0301764457b9a90d9557a6be7fcc1544a8beac17979153907c3f490094f69c292d094e997dbd47b5f2f19018e449d209f84c840523f2cea04c7bbad05bda14d8c241cba879e38d8da36088eba9e1aa61d65f8afe9c3a60a1840523f2cfa07391e48b0d7ac748ec371296321c0e50d06287ea6d32338f7137bc91c0fb74ef80b8887bd75e77b54f9f332cb413c5419ed7088aeea020757f3740481048fde566461070b0041faeee8c80363e30d69c4a06353d5c94a0142a4c384831c5775f650000000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855d564c151db68b6289cbc06de620bf26cf6de192f583581d364b052ae576c54621dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0cddfe41adc838822352e5b675cc7fb3ab13069968144be7efdd79e2f0a3e9dc626f553e73c12b7d612af6e685d4c0e6d40fe41899d33d5b1a930b9d310e605ff461c3a9df972a3f877009a69c2c537edc27325cb8961e776fda408b04a9ca5df048000000800000000000040000000000000000008000000400000100000002000411000402020080010000800000000000000000000000200000050000c04000000000004000000000000080000100020108000040400008000010000000001000800200202002000000000000008010800000000404000000002140000000000002000400000000000000001000800400004800002400000000800000000240000000000000020080001000600001000000108000000400000100000000000000000024000080080000000000000000000008014000000001440a20100700000200000000000000900002408060100000880000480000040040000000010000200000000000000000000000000000000000000000000000000000000000000d1f22305000000000000000000000000000000000000000000000000000000004ddcf8050000000012780b00000000003d5e74690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b482017fb860a398d7a07996af30b4a3975d26a0972eadfb1dde532dcd8f70308a423dedc00fcff20731c9fc9d3def37a04dbd5e439a1396a14977a4df0c8a7980cf26a8d4d6e6b6cf5f37571e34e85105af0cec32da1c6a8a97e41ada17d70134aef86a18a9f84c840523f2cfa07391e48b0d7ac748ec371296321c0e50d06287ea6d32338f7137bc91c0fb74ef840523f2d0a0d564c151db68b6289cbc06de620bf26cf6de192f583581d364b052ae576c5462802dcff6290debc62f75869ee5be8e531d2ab67a61440289cf93eed14065cfa4581732919826816527ad8597871be33e3c7e31ef4e9ea1ab8accc1456b1a18d4370100000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b8555389c2b4be55220c12b27b4670347557819a42c27bc98875c39b35f43efe4d571dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0c2eb27bd2ffbae4480897bedb763329e97410e3d6de2b90226d281d85fcfa86a763b9d1244d39bae813ce9f3bc21207eca60212969dd7400b72717c702045233f4d672abcd80e6888a4f599eacd1d157946733c4878488f577266c4543d43bf2048000000200002000000442004000000000000000000000000010020000002800011010400000000000000040001008000000000000000000008150000600080000020001000100000000080000000028100004040401000000000000000020001800200302000080000000000008000800000000c040000000001400000000008000806020000000000000050200004000048400200000000000000000002408000000000000240c0001000200001080000000000000400080000000000000000000024010000000000000000020000000008010000001001440a20100700000200000000000100300002400000100000880000c90000040000000000000000200000000000000000000000000000000000000000000000000000000000000d2f2230500000000000000000000000000000000000000000000000000000000835afa0500000000ff7e0c00000000003d5e74690000000015010000000000000000000000000000000000000000000000000000000000000000000000000000f8b277b8608f0724a746658106ff752d8bd2e875023a6dfe0c17c18c6ca137550c7283816a243793f49c213e98efe66e3e957bd6e50e26164104e93148bdebfd1da60dcfc1b42222968f5b9fb019f89d4007bfb1e6684bb83574529a98154e35bd95dca83af84c840523f2d0a0d564c151db68b6289cbc06de620bf26cf6de192f583581d364b052ae576c5462840523f2d1a05389c2b4be55220c12b27b4670347557819a42c27bc98875c39b35f43efe4d5780a7fa42451f90c0aa540c0bcc83a97c8ed74057650982efed998bf8a319cc38994bc3072a81595bdb30e99f8f2611daef706e7240ea692ea6d4c6bdcc122f5d700100000000000000000000000000000000000000000000000000000000000003b60000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
    )).unwrap();

    let valset = valset![
        [
            "08265da01e1a65d62b903c7b34c08cb389bf3d99",
            "96f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c2"
        ],
        [
            "1a3d9d7a717d64e6088ac937d5aacdd3e20ca963",
            "979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd998500230"
        ],
        [
            "32415e630b9b3489639dee7de21274ab64016226",
            "a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c"
        ],
        [
            "53387f3321fd69d1e030bb921230dfb188826aff",
            "aa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b"
        ],
        [
            "76d76ee8823de52a1a431884c2ca930c5e72bff3",
            "803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf"
        ],
        [
            "798443fb327cad5dfd47ca4ddb15bb876d6c40e0",
            "91b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f26"
        ],
        [
            "7f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea",
            "99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf"
        ],
        [
            "90409f56966b5da954166eb005cb1a8790430ba1",
            "962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5"
        ],
        [
            "d447b49cd040d20bc21e49ffea6487f5638e4346",
            "ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb"
        ],
    ];

    let ctx = BlstContext {
        current_timestamp: Timestamp::from_nanos(1753916740000000000),
        epoch_valsets: [(86241000, valset)].into_iter().collect(),
    };

    let err = verify_header(&header.chain, Duration::from_secs(604800), 86241000, ctx).unwrap_err();

    assert!(matches!(err, Error::SupermajorityNotReached));
}
