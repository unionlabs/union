use parlia_types::ParliaHeader;

/// Update the client via the Fast Finality ([BEP-126](bep-126)) finality mechanism.
///
/// [bep-126]: https://github.com/bnb-chain/BEPs/blob/master/BEPs/BEP126.md
#[derive(Debug, Clone, PartialEq)]
#[cfg_attr(
    feature = "serde",
    derive(serde::Serialize, serde::Deserialize),
    serde(deny_unknown_fields, rename_all = "snake_case")
)]
#[cfg_attr(feature = "bincode", derive(bincode::Encode, bincode::Decode))]
pub struct Header {
    /// The valset that signed `attestation`.
    pub trusted_valset_epoch_number: u64,
    /// The chain of headers to use in the verification. This must contain the attestation, target, and source, and it may additionally contain any additional parents of source that will be verified via an ancestry chain check.
    ///
    /// ```txt
    /// [..ancestors, source, target, attestation]
    /// ```
    pub chain: Vec<ParliaHeader>,
}

#[cfg(test)]
mod tests {
    use hex_literal::hex;
    use parlia_types::Nullable;
    use unionlabs::{encoding::Bincode, primitives::U256, test_utils::assert_codec_iso_bytes};

    use super::*;

    #[test]
    fn bincode() {
        let bz = hex!(
            "58c519050000000003000000000000001b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e009fba05c7a11ece03605aa39d4547fdf88879dcf24e6ab42002afcef9736166b5adafd0e270c2cbbd98aa3981d277b454de95d78e5a344326e2e85e60341ae95754b58c162523ed2226e69b09e4e946bb4e6518fc0a5758fe9783bf18ef4a0ed040000004000400000000040000000000200000000000000000000000200000000001000000000000000100000000000000000000000000000000000000000000000000000000001000000000000000021100000040000000000000000000000000c0020800200010000000000000000080004000000000000200000000000000000080000000000000000000000020000000400000000020000000000000020000000000000002008000000028000000000000000001000000000000000000000000000000000000000042000000000400000001000024000104802000000000000000000000000011000840000010400088000008000004100200000000000020000000000000000000000000000000000000000000000000000000000000040c9190500000000000000000000000000000000000000000000000000000000775ef70500000000e74c030000000000c1c46f69000000007d0300000000000000000000000000000000000000000000000000000000000000000000000000000908265da01e1a65d62b903c7b34c08cb389bf3d9996f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c21a3d9d7a717d64e6088ac937d5aacdd3e20ca963979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd99850023032415e630b9b3489639dee7de21274ab64016226a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c53387f3321fd69d1e030bb921230dfb188826affaa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b76d76ee8823de52a1a431884c2ca930c5e72bff3803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf798443fb327cad5dfd47ca4ddb15bb876d6c40e091b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f267f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf90409f56966b5da954166eb005cb1a8790430ba1962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5d447b49cd040d20bc21e49ffea6487f5638e4346ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb08f8b48201ffb860913a9ed7fe9bfbe749272684dc2b1d16f1934ffc775ca8f408a6cab74977263e15a61677e0642a323a933bd585e66813108bac33a479f5f1e9d5be8d0f419b4eaa8108bed049ce94c233dca6c122d9419168bb4f5416075af99ad7d1a82a6054f84c840519c93ea09ebd3dd083051861c56bd2ced35d29854ea6339e64b49949f71bfa295ce9c30d840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a80ba25c17d0755008ddbcb85a0a82c813a977c78b3923613c3d3939a39e900e8d05e66017b628a499e1df929db8ebfe3923d1bf3cfe77ea716ac16983c19a9960a0000000000000000000000000000000000000000000000000000000000000002580000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e71dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e0a7c3244e3d9864f6dce79aa2814b0d5749dde74929ecccb31f09e55f091f052d388cd48da311e54bad28832f05ba5be7da5b82405b1f707c00f5319b1ac657fa3db0b077374fd66a6f595255d93b3aedd7799d834fbc940b62bda414b7f94bd300000000000000000000004000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000002000000000000000000000000000000002010000004000000000000000000000000080020000200000000000000000001080000000000000000000000000000000000000000000000000000000000000000000400000000400000080000000020000000000000002008000000020000000000000000000000000000000000800000000000000000000000000000000000000000001000000000104002000000000000000000000000010000040000010000088800000000004000000000000000020000000000000000000000000000000000000000000000000000000000000041c91905000000000000000000000000000000000000000000000000000000004ddcf80500000000de46010000000000c2c46f690000000017010000000000000000000000000000000000000000000000000000000000000000000000000000f8b482017fb860abb6798ac8cc9f3434576c3d6e1fe826e9460eded136b70a1685dcbc289657dbee0e14f2059e65faf6d922459ea66ba20489ce7f8d84a431609d428dba46d71744b942d8196a8edf239d5b1630929877a3d9fd8d88779d509a410f31c76a7c3ff84c840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a840519c940a0098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e78068c0679c9640033a6e6c617147185a739260b7ea6c2fe48f73d30aed2bd044cf50965f90de1294fa84cb05218a56d00094e502da6e100be7caab71877ab191e00100000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855a7662681beb5fb69d32cc869dded69b0a4abeb3af22c95e4790e2393b0f8a4ac1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347798443fb327cad5dfd47ca4ddb15bb876d6c40e01a8042b95cade79f8241ba68f8423655e6ca24eba3c05b4e7ef149d5390b145774c0b27fdf5c08b695921527773f159ae2f2d2698f15191da63626b04ad2488947f8daabeb56faf4e9e88485084f5902a6b365f6adf778bb8b6745e45f70ee35048000000000000000000040000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000010000000000000000000000000000000080000100020100000040000000000000000000000000800200002000000000000000000000800000000004000000000140010000000000000400000000000000000000000000404000000000000000000000000200000000000000020080001000200000000000000000000400000000000000000040000024000000080000000000000000000008010000000001440a2000020000000000000000000010000240000010000088000048000004000000000000000020000000000000000000000000000000000000000000000000000000000000042c9190500000000000000000000000000000000000000000000000000000000835afa05000000003029020000000000c2c46f6900000000610000000000000000000000000000000000000000000000000000000000000000000000000000003bf215bb1f1785155eec5a5b53ef9776829a8a4d25a58252db80182f8369c1eb696e62b4ae8365bcb49cf90cee6cbdfa0a7cf82d5c1c187d6de660a75cfda9960000000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000000000000000000000000056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b42100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
        );

        let header = Header {
            trusted_valset_epoch_number: 85575000,
            chain: [
                ParliaHeader {
                    parent_hash: hex!("1b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a").into(),
                    sha3_uncles: hex!("1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347").into(),
                    miner: hex!("798443fb327cad5dfd47ca4ddb15bb876d6c40e0").into(),
                    state_root: hex!("09fba05c7a11ece03605aa39d4547fdf88879dcf24e6ab42002afcef9736166b").into(),
                    transactions_root: hex!("5adafd0e270c2cbbd98aa3981d277b454de95d78e5a344326e2e85e60341ae95").into(),
                    receipts_root: hex!("754b58c162523ed2226e69b09e4e946bb4e6518fc0a5758fe9783bf18ef4a0ed").into(),
                    logs_bloom: Box::new(hex!("040000004000400000000040000000000200000000000000000000000200000000001000000000000000100000000000000000000000000000000000000000000000000000000001000000000000000021100000040000000000000000000000000c0020800200010000000000000000080004000000000000200000000000000000080000000000000000000000020000000400000000020000000000000020000000000000002008000000028000000000000000001000000000000000000000000000000000000000042000000000400000001000024000104802000000000000000000000000011000840000010400088000008000004100200000000000").into()),
                    difficulty: U256::from(2_u64),
                    number: U256::from(85576000_u64),
                    gas_limit: 100097655,
                    gas_used: 216295,
                    timestamp: 1768932545,
                    extra_data: hex!("00000000000000000000000000000000000000000000000000000000000000000908265da01e1a65d62b903c7b34c08cb389bf3d9996f763f030b1adcfb369c5a5df4a18e1529baffe7feaec66db3dbd1bc06810f7f6f88b7be6645418a7e2a2a3f40514c21a3d9d7a717d64e6088ac937d5aacdd3e20ca963979974cd8ff90cbf097023dc8c448245ceff671e965d57d82eaf9be91478cfa0f24d2993e0c5f43a6c5a4cd99850023032415e630b9b3489639dee7de21274ab64016226a80ebd07bd9d717bd538413e8830f673e63dfad496c901de324be5d16b0496aee39352ecfb84fa58d8d8a67746f8ae6c53387f3321fd69d1e030bb921230dfb188826affaa39ebf1c38b190851e4db0588a3e90142c5299041fb8a0db3bb9a1fa4bdf0dae84ca37ee12a6b8c26caab775f0e007b76d76ee8823de52a1a431884c2ca930c5e72bff3803af79641cf964cc001671017f0b680f93b7dde085b24bbc67b2a562a216f903ac878c5477641328172a353f1e493cf798443fb327cad5dfd47ca4ddb15bb876d6c40e091b65958627f84f80ff9765ab46194286e526798f61e3553856d9fde348ed26f18f3a8be52f706ab61584a46b0e16f267f5f2cf1aec83bf0c74df566a41aa7ed65ea84ea99e3849ef31887c0f880a0feb92f356f58fbd023a82f5311fc87a5883a662e9ebbbefc90bf13aa533c2438a4113804bf90409f56966b5da954166eb005cb1a8790430ba1962a2342bac4831c6de73fcb77ad08669aaaa0a2ba6c6973a02b8928dbe573d17864e48c3521f238ace1c16e160bb7f5d447b49cd040d20bc21e49ffea6487f5638e4346ad9fc6d1ec30e28016d3892b51a7898bd354cfe78643453fd3868410da412de7f2883180d0a2840111ad2e043fa403eb08f8b48201ffb860913a9ed7fe9bfbe749272684dc2b1d16f1934ffc775ca8f408a6cab74977263e15a61677e0642a323a933bd585e66813108bac33a479f5f1e9d5be8d0f419b4eaa8108bed049ce94c233dca6c122d9419168bb4f5416075af99ad7d1a82a6054f84c840519c93ea09ebd3dd083051861c56bd2ced35d29854ea6339e64b49949f71bfa295ce9c30d840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a80ba25c17d0755008ddbcb85a0a82c813a977c78b3923613c3d3939a39e900e8d05e66017b628a499e1df929db8ebfe3923d1bf3cfe77ea716ac16983c19a9960a00").into(),
                    mix_hash: hex!("0000000000000000000000000000000000000000000000000000000000000258").into(),
                    nonce: hex!("0000000000000000").into(),
                    base_fee_per_gas: U256::ZERO,
                    withdrawals_root: hex!("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421").into(),
                    blob_gas_used: 131072,
                    excess_blob_gas: 0,
                    parent_beacon_block_root: hex!("0000000000000000000000000000000000000000000000000000000000000000").into(),
                    requests_hash: Nullable(
                        Some(
                            hex!("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855").into(),
                        ),
                    ),
                },
                ParliaHeader {
                    parent_hash: hex!("098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e7").into(),
                    sha3_uncles: hex!("1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347").into(),
                    miner: hex!("798443fb327cad5dfd47ca4ddb15bb876d6c40e0").into(),
                    state_root: hex!("a7c3244e3d9864f6dce79aa2814b0d5749dde74929ecccb31f09e55f091f052d").into(),
                    transactions_root: hex!("388cd48da311e54bad28832f05ba5be7da5b82405b1f707c00f5319b1ac657fa").into(),
                    receipts_root: hex!("3db0b077374fd66a6f595255d93b3aedd7799d834fbc940b62bda414b7f94bd3").into(),
                    logs_bloom: Box::new(hex!("00000000000000000000004000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000002000000000000000000000000000000002010000004000000000000000000000000080020000200000000000000000001080000000000000000000000000000000000000000000000000000000000000000000400000000400000080000000020000000000000002008000000020000000000000000000000000000000000800000000000000000000000000000000000000000001000000000104002000000000000000000000000010000040000010000088800000000004000000000000000").into()),
                    difficulty: U256::from(2_u64),
                    number: U256::from(85576001_u64),
                    gas_limit: 100195405,
                    gas_used: 83678,
                    timestamp: 1768932546,
                    extra_data: hex!("0000000000000000000000000000000000000000000000000000000000000000f8b482017fb860abb6798ac8cc9f3434576c3d6e1fe826e9460eded136b70a1685dcbc289657dbee0e14f2059e65faf6d922459ea66ba20489ce7f8d84a431609d428dba46d71744b942d8196a8edf239d5b1630929877a3d9fd8d88779d509a410f31c76a7c3ff84c840519c93fa01b852162ca0e8f85ce28423ad803d00268f293092550aed4ee8102fcd3e98a5a840519c940a0098177ad0b59d9d04f102a7eb600f149ea9d7d279747df01236bf9308e2a99e78068c0679c9640033a6e6c617147185a739260b7ea6c2fe48f73d30aed2bd044cf50965f90de1294fa84cb05218a56d00094e502da6e100be7caab71877ab191e001").into(),
                    mix_hash: hex!("0000000000000000000000000000000000000000000000000000000000000032").into(),
                    nonce: hex!("0000000000000000").into(),
                    base_fee_per_gas: U256::ZERO,
                    withdrawals_root: hex!("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421").into(),
                    blob_gas_used: 0,
                    excess_blob_gas: 0,
                    parent_beacon_block_root: hex!("0000000000000000000000000000000000000000000000000000000000000000").into(),
                    requests_hash: Nullable(
                        Some(
                            hex!("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855").into(),
                        ),
                    ),
                },
                ParliaHeader {
                    parent_hash: hex!("a7662681beb5fb69d32cc869dded69b0a4abeb3af22c95e4790e2393b0f8a4ac").into(),
                    sha3_uncles: hex!("1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347").into(),
                    miner: hex!("798443fb327cad5dfd47ca4ddb15bb876d6c40e0").into(),
                    state_root: hex!("1a8042b95cade79f8241ba68f8423655e6ca24eba3c05b4e7ef149d5390b1457").into(),
                    transactions_root: hex!("74c0b27fdf5c08b695921527773f159ae2f2d2698f15191da63626b04ad24889").into(),
                    receipts_root: hex!("47f8daabeb56faf4e9e88485084f5902a6b365f6adf778bb8b6745e45f70ee35").into(),
                    logs_bloom: Box::new(hex!("048000000000000000000040000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000010000000000000000000000000000000080000100020100000040000000000000000000000000800200002000000000000000000000800000000004000000000140010000000000000400000000000000000000000000404000000000000000000000000200000000000000020080001000200000000000000000000400000000000000000040000024000000080000000000000000000008010000000001440a2000020000000000000000000010000240000010000088000048000004000000000000000").into()),
                    difficulty: U256::from(2_u64),
                    number: U256::from(85576002_u64),
                    gas_limit: 100293251,
                    gas_used: 141616,
                    timestamp: 1768932546,
                    extra_data: hex!("00000000000000000000000000000000000000000000000000000000000000003bf215bb1f1785155eec5a5b53ef9776829a8a4d25a58252db80182f8369c1eb696e62b4ae8365bcb49cf90cee6cbdfa0a7cf82d5c1c187d6de660a75cfda99600").into(),
                    mix_hash: hex!("00000000000000000000000000000000000000000000000000000000000001f4").into(),
                    nonce: hex!("0000000000000000").into(),
                    base_fee_per_gas: U256::ZERO,
                    withdrawals_root: hex!("56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421").into(),
                    blob_gas_used: 0,
                    excess_blob_gas: 0,
                    parent_beacon_block_root: hex!("0000000000000000000000000000000000000000000000000000000000000000").into(),
                    requests_hash: Nullable(
                        Some(
                            hex!("e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855").into(),
                        ),
                    ),
                },
            ].into(),
        };

        assert_codec_iso_bytes::<_, Bincode>(&header, &bz);
    }
}
