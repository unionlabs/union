name: e2e

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'The repository from which the slash command was dispatched'
        required: true
      comment-id:
        description: 'The comment-id of the slash command'
        required: true

jobs:
  start-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: LouisBrunner/checks-action@v1.6.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: e2e
          status: in_progress

  e2e:
    uses: ./.github/workflows/e2e.yml
    secrets:
      nixbuild_token: ${{ secrets.nixbuild_token }}
      github-token: ${{ secrets.GITHUB_TOKEN }}
    needs: [ start-check ] 

  respond:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    needs: [ e2e ] 
    steps:
      - uses: technote-space/workflow-conclusion-action@v3
      - uses: LouisBrunner/checks-action@v1.6.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: e2e
          status: completed
          conclusion: ${{ env.WORKFLOW_CONCLUSION }}
      - name: Add reaction after completion
        uses: peter-evans/create-or-update-comment@v2
        if: success()
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.inputs.repository }}
          comment-id: ${{ github.event.inputs.comment-id }}
          reaction-type: hooray
      - name: Add reaction after completion
        uses: peter-evans/create-or-update-comment@v2
        if: failure()
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.inputs.repository }}
          comment-id: ${{ github.event.inputs.comment-id }}
          reaction-type: confused